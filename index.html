<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ù…Ù†ØµØ© Ø¯Ø±Ø¯Ø´Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ©</title>
    <style>
        /* --- 1. Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙˆØ§Ù„Ù…ØªØºÙŠØ±Ø§Øª --- */
        :root {
            --primary-color: #6A5ACD; --secondary-color: #7B68EE; --accent-color: #00C9A7;
            --danger-color: #E94560; --read-receipt-color: #00C9A7; --info-color: #3498db;
            --background-color: #F4F6FC; --chat-bg-color: #EAEBEE;
            --my-message-bg: linear-gradient(135deg, #6A5ACD, #7B68EE);
            --other-message-bg: #FFFFFF; --text-color: #2c3e50; --light-text-color: #8a99ab;
            --white-color: #FFFFFF; --border-color: #e1e5ea; --deleted-message-color: #95a5a6;
            --card-shadow: 0 4px 15px rgba(0, 0, 0, 0.06); --header-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap');
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        html { height: -webkit-fill-available; }
        body { font-family: 'Tajawal', sans-serif; background-color: var(--primary-color); color: var(--text-color); height: 100vh; height: 100svh; overflow: hidden; display: flex; justify-content: center; align-items: center; }
        .hidden { display: none !important; } .icon { width: 24px; height: 24px; stroke-width: 2; }
        .icon-sm { width: 16px; height: 16px; stroke-width: 2.5; } .icon-btn { background:none; border:none; cursor:pointer; padding: 4px; color: var(--light-text-color); display:flex; align-items:center; }
        .icon-btn:hover { color: var(--primary-color); } .btn-secondary { background: var(--background-color); color: var(--text-color); border: 1px solid var(--border-color); }
        .btn-primary { background-color: var(--primary-color); color: var(--white-color); border: none; }
        #app-wrapper { width: 100%; height: 100%; max-width: 450px; background: var(--background-color); display: flex; flex-direction: column; box-shadow: 0 10px 40px rgba(0,0,0,0.2); position: relative; }
        @media (min-width: 451px) { #app-wrapper { max-height: 90vh; border-radius: 20px; } }
        /* --- 2. ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© (Auth) --- */
        #auth-view { width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; background: var(--background-color); color: var(--text-color); }
        .auth-box { background: var(--white-color); padding: 40px 30px; border-radius: 16px; box-shadow: var(--card-shadow); width: 100%; max-width: 350px; }
        .auth-box h2 { text-align: center; margin-bottom: 25px; color: var(--primary-color); font-size: 24px; }
        .auth-form input { width: 100%; padding: 14px; margin-bottom: 15px; border-radius: 10px; border: 1px solid var(--border-color); font-size: 16px; font-family: 'Tajawal'; background: var(--background-color); }
        .auth-form input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(106, 90, 205, 0.2); }
        .auth-form button { width: 100%; padding: 14px; border: none; border-radius: 10px; background-color: var(--primary-color); color: var(--white-color); font-size: 18px; font-weight: 700; cursor: pointer; transition: background-color 0.3s, transform 0.2s; }
        .auth-toggle { text-align: center; margin-top: 20px; font-size: 14px; } .auth-toggle a { color: var(--primary-color); text-decoration: none; cursor: pointer; font-weight: 700; }
        .auth-error { color: var(--danger-color); text-align: center; margin-bottom: 15px; font-size: 14px; min-height: 20px; font-weight: 500;}
        /* --- 3. Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© --- */
        #main-app-view { width: 100%; height: 100%; display: flex; flex-direction: column; }
        #app-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: var(--white-color); color: var(--primary-color); flex-shrink: 0; box-shadow: var(--header-shadow); z-index: 10; }
        #welcome-message { font-size: 18px; font-weight: 700; }
        #logout-btn { background: none; border: none; color: var(--light-text-color); cursor: pointer; padding: 5px; }
        #app-content { flex-grow: 1; overflow-y: auto; padding: 20px 15px; padding-bottom: 90px; }
        .list-view h3, .list-view h4 { margin-bottom: 15px; padding-right: 5px; color: var(--primary-color); font-size: 20px; font-weight: 700; }
        .list-view ul { list-style: none; }
        .list-item, .request-item, .friend-item, .search-result-item { display: flex; align-items: center; padding: 15px; border-radius: 12px; margin-bottom: 12px; background: var(--white-color); box-shadow: var(--card-shadow); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .list-item:active, .search-result-item:active { transform: scale(0.98); } .list-item-content { flex-grow: 1; font-weight: 500; font-size: 16px; }
        .online-indicator { width: 12px; height: 12px; background-color: var(--light-text-color); border-radius: 50%; margin-left: 15px; transition: background-color 0.3s; border: 2px solid var(--background-color); }
        .online-indicator.online { background-color: var(--accent-color); }
        #no-private-chats-placeholder { text-align: center; padding: 40px 20px; color: var(--light-text-color); background: transparent; box-shadow: none; }
        #app-nav { position: absolute; bottom: 0; right: 0; left: 0; display: flex; background-color: var(--white-color); flex-shrink: 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.07); padding: 10px 0; border-top-right-radius: 20px; border-top-left-radius: 20px; }
        .nav-btn { flex-grow: 1; padding: 8px 5px; text-align: center; cursor: pointer; border: none; background: none; color: var(--light-text-color); transition: all 0.2s; display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 12px; font-weight: 500; }
        .nav-btn.active { color: var(--primary-color); transform: translateY(-3px); } .nav-btn.active .icon { stroke: var(--primary-color); }
        .form-group { display: flex; flex-direction: column; gap: 15px; padding: 20px; background: var(--white-color); border-radius: 12px; box-shadow: var(--card-shadow); margin-bottom: 20px; }
        #search-user-form { flex-direction: row; align-items: center; padding: 10px; }
        .form-group input, #search-username-input { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--background-color); font-family: 'Tajawal'; }
        .form-group button { padding: 12px 15px; border: none; background-color: var(--secondary-color); color: white; border-radius: 8px; cursor: pointer; font-weight: 700; }
        /* --- 4. ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© --- */
        #chat-view { position: absolute; top: 0; right: 0; width: 100%; height: 100%; background: var(--chat-bg-color); display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1000; }
        #chat-view.active { transform: translateX(0); }
        .chat-header { background-color: var(--white-color); color: var(--text-color); padding: 10px 15px; display: flex; align-items: center; box-shadow: var(--header-shadow); flex-shrink: 0; gap: 10px; }
        #back-to-list-btn { background: none; border: none; color: var(--text-color); cursor: pointer; }
        .chat-title-group { flex-grow: 1; } #chat-title { font-size: 17px; font-weight: 700; }
        #typing-indicator { font-size: 12px; color: var(--accent-color); height: 16px; font-style: italic; transition: opacity 0.3s; }
        .messages-list { flex-grow: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 2px; }
        .chat-start-info { text-align: center; color: var(--light-text-color); padding: 20px; font-size: 13px; }
        .message-form-container { flex-shrink: 0; display: flex; padding: 10px 15px; background-color: var(--white-color); border-top: 1px solid var(--border-color); align-items: center; box-shadow: 0 -2px 5px rgba(0,0,0,0.05); }
        #message-form { width: 100%; display:flex; align-items: center; gap: 10px; }
        #message-input { flex-grow: 1; padding: 12px 20px; border: none; border-radius: 25px; font-size: 16px; background-color: var(--background-color); }
        #message-input:focus { outline: none; }
        #send-button { width: 48px; height: 48px; border: none; background-color: var(--light-text-color); color: white; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; flex-shrink: 0; transition: all 0.2s; transform: scale(0.9); }
        #send-button.has-text { background-color: var(--primary-color); transform: scale(1); }
        .message { max-width: 85%; padding: 10px 15px; border-radius: 20px; display: flex; flex-wrap: wrap; align-items: flex-end; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.05); margin-bottom: 2px; border-left: 4px solid transparent; }
        .message.flagged { border-left-color: var(--danger-color); }
        .message.my-message { background: var(--my-message-bg); align-self: flex-end; color: var(--white-color); border-bottom-right-radius: 5px; } 
        .message.other-message { background-color: var(--other-message-bg); align-self: flex-start; border-bottom-left-radius: 5px; } 
        .message.consecutive { margin-top: 0; margin-bottom: 0; border-radius: 20px; }
        .my-message.consecutive { border-top-right-radius: 5px; border-bottom-right-radius: 5px; } .other-message.consecutive { border-top-left-radius: 5px; border-bottom-left-radius: 5px; }
        .message-text { font-size: 15px; line-height: 1.5; word-wrap: break-word; min-width: 0; }
        .message.deleted .message-text { color: var(--deleted-message-color); font-style: italic; }
        .message-meta { font-size: 11px; color: var(--light-text-color); display: flex; align-items: center; gap: 4px; margin-right: auto; padding-left: 10px; white-space: nowrap; align-self: flex-end; flex-shrink: 0; }
        .message.my-message .message-meta { color: rgba(255, 255, 255, 0.8); }
        .message.my-message .message-status svg { stroke: rgba(255, 255, 255, 0.9); } .message.my-message .message-status svg[style*="var(--read-receipt-color)"] { stroke: var(--read-receipt-color); }
        .delete-btn { position: absolute; top: -10px; right: -10px; cursor: pointer; display: none; background: var(--danger-color); color: white; border-radius: 50%; width: 22px; height: 22px; align-items: center; justify-content: center; border: none; font-size: 14px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .message.my-message:not(.deleted):hover .delete-btn { display: flex; }
        /* --- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¨Ø­Ø« --- */
        #search-results { min-height: 200px; display: flex; justify-content: center; align-items: center; }
        .search-placeholder { text-align: center; color: var(--light-text-color); }
        .search-placeholder svg { width: 60px; height: 60px; margin-bottom: 15px; stroke: var(--border-color); }
        .loader { width: 32px; height: 32px; border: 4px solid var(--background-color); border-top-color: var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .search-result-item { cursor: default; flex-direction: column; align-items: stretch; }
        .result-content { display: flex; align-items: center; flex-grow: 1; }
        .avatar { width: 48px; height: 48px; border-radius: 50%; background: var(--secondary-color); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 20px; margin-left: 15px; }
        .user-info .display-name { font-weight: 700; font-size: 16px; color: var(--text-color); } .user-info .username { font-size: 14px; color: var(--light-text-color); }
        .result-action button { border: none; padding: 8px 14px; border-radius: 8px; color: white; cursor: pointer; font-weight: 700; font-family: 'Tajawal'; }
        .result-action .send-request-btn { background-color: var(--accent-color); color: var(--text-color); }
        /* --- 5. Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Toast --- */
        #toast-container { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); z-index: 2000; display: flex; flex-direction: column; align-items: center; gap: 10px; width: 90%; max-width: 420px; }
        .toast { padding: 12px 20px; color: white; border-radius: 10px; box-shadow: 0 3px 10px rgba(0,0,0,0.2); opacity: 0; transform: translateY(20px); transition: all 0.3s; font-weight: 500; text-align: center; }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.success { background-color: var(--accent-color); } .toast.error { background-color: var(--danger-color); } .toast.info { background-color: var(--info-color); }
        /* --- 6. ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª --- */
        .settings-group { margin-bottom: 25px; } .settings-group-title { color: var(--primary-color); font-size: 16px; font-weight: 700; margin-bottom: 10px; padding-right: 5px; }
        .settings-list { background: var(--white-color); border-radius: 12px; box-shadow: var(--card-shadow); overflow: hidden; }
        .settings-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid var(--background-color); font-size: 16px; }
        .settings-item:last-child { border-bottom: none; } .settings-item.clickable { cursor: pointer; }
        .settings-item .value { color: var(--light-text-color); font-weight: 500; } .settings-item.danger { color: var(--danger-color); }
        #edit-display-name-form { padding: 15px; border-top: 1px solid var(--background-color); display: flex; gap: 10px; align-items: center; }
        #change-password-section { background: var(--white-color); padding: 20px; border-radius: 12px; box-shadow: var(--card-shadow); margin-top: 15px; }
        #friends-management-list .friend-item { box-shadow: none; padding: 15px; margin-bottom: 0; border-bottom: 1px solid var(--background-color); border-radius: 0; cursor: default; }
        .request-actions button, .friend-item .remove-btn { border: none; padding: 8px 14px; border-radius: 8px; color: white; cursor: pointer; margin-right: 5px; font-weight: 500; font-family: 'Tajawal'; }
        .request-actions .accept-btn { background-color: var(--secondary-color); } .request-actions .decline-btn, .friend-item .remove-btn { background-color: var(--danger-color); }
    </style>
</head>
<body>

<div id="app-wrapper">
    <!-- 1. ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© -->
    <div id="auth-view">
        <div class="auth-box">
            <form id="login-form" class="auth-form">
                <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
                <div id="login-error" class="auth-error"></div>
                <input type="text" id="login-username" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" required>
                <input type="password" id="login-password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required>
                <button type="submit">Ø¯Ø®ÙˆÙ„</button>
                <p class="auth-toggle">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ <a id="show-signup">Ø£Ù†Ø´Ø¦ Ø­Ø³Ø§Ø¨Ù‹Ø§</a></p>
            </form>
            <form id="signup-form" class="auth-form hidden">
                <h2>Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
                <div id="signup-error" class="auth-error"></div>
                <input type="text" id="signup-username" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ÙØ±ÙŠØ¯ØŒ Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©)" required pattern="[a-zA-Z0-9_]+">
                <input type="text" id="signup-displayname" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø°ÙŠ Ø³ÙŠØ¸Ù‡Ø± Ø¨Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©" required>
                <input type="password" id="signup-password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required>
                <button type="submit">Ø¥Ù†Ø´Ø§Ø¡</button>
                <p class="auth-toggle">Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ <a id="show-login">Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a></p>
            </form>
        </div>
    </div>

    <!-- 2. Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <div id="main-app-view" class="hidden">
        <header id="app-header">
            <span id="welcome-message"></span>
            <button id="logout-btn" title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬">
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
            </button>
        </header>

        <main id="app-content">
            <!-- Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª -->
            <div id="private-chats-list-view" class="list-view">
                <h4>Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµØ¯Ø§Ù‚Ø©</h4>
                <ul id="friend-requests-list"></ul>
                <h3 style="margin-top: 20px;">Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª</h3>
                <ul id="private-chats-list">
                    <li id="no-private-chats-placeholder">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø®Ø§ØµØ© Ø¨Ø¹Ø¯. Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£ØµØ¯Ù‚Ø§Ø¡!</li>
                </ul>
            </div>
            
            <!-- Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø­Ø« -->
            <div id="search-view" class="list-view hidden">
                <h3>Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
                <form id="search-user-form" class="form-group">
                    <input type="text" id="search-username-input" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…..." required>
                    <button type="submit">
                        <svg class="icon" style="stroke: white;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </button>
                </form>
                <div id="search-results"></div>
            </div>

            <!-- Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
            <div id="settings-view" class="list-view hidden">
                <h3>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h3>
                <div class="settings-group">
                    <h4 class="settings-group-title">Ø§Ù„Ø­Ø³Ø§Ø¨</h4>
                    <div class="settings-list">
                        <div class="settings-item"><span>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</span><span id="setting-username" class="value"></span></div>
                        <div id="display-name-container">
                            <div class="settings-item">
                                <span>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¸Ø§Ù‡Ø±</span>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span id="setting-display-name" class="value"></span>
                                    <button id="edit-display-name-btn" class="icon-btn" title="ØªØ¹Ø¯ÙŠÙ„"><svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z"></path></svg></button>
                                </div>
                            </div>
                            <form id="edit-display-name-form" class="hidden" style="padding: 15px; border-top: 1px solid var(--background-color); display: flex; gap: 10px; align-items: center;">
                                <input type="text" id="new-display-name-input" required style="flex-grow:1; padding:10px; border-radius:8px; border:1px solid var(--border-color);">
                                <button type="submit" class="btn-primary" style="padding:10px 15px; border-radius: 8px;">Ø­ÙØ¸</button>
                                <button type="button" id="cancel-edit-display-name" class="btn-secondary" style="padding:10px 15px; border-radius: 8px;">Ø¥Ù„ØºØ§Ø¡</button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="settings-group">
                    <h4 class="settings-group-title">Ø§Ù„Ø£Ù…Ø§Ù†</h4>
                     <div class="settings-list"><div id="toggle-password-form-btn" class="settings-item clickable"><span>ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</span><svg class="icon" style="stroke:var(--light-text-color); transform: rotate(180deg);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"></path></svg></div></div>
                    <div id="change-password-section" class="hidden">
                        <form id="change-password-form" style="display:flex; flex-direction:column; gap:10px;">
                            <input type="password" id="old-password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©" required>
                            <input type="password" id="new-password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©" required>
                            <button type="submit" class="btn-primary" style="padding:12px;">ØªØ­Ø¯ÙŠØ«</button>
                        </form>
                    </div>
                </div>
                 <div class="settings-group">
                    <h4 class="settings-group-title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</h4>
                    <div class="settings-list"><ul id="friends-management-list"></ul></div>
                </div>
                <div class="settings-group">
                    <h4 class="settings-group-title">Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø®Ø·Ø±</h4>
                    <div class="settings-list"><div id="delete-account-btn" class="settings-item clickable danger"><span>Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹</span><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></div></div>
                </div>
            </div>
        </main>

        <nav id="app-nav">
            <button class="nav-btn active" data-view="private-chats-list-view"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg><span>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª</span></button>
            <button class="nav-btn" data-view="search-view"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg><span>Ø¨Ø­Ø«</span></button>
            <button class="nav-btn" data-view="settings-view"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg><span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span></button>
        </nav>
    </div>

    <!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© -->
    <div id="chat-view">
        <header class="chat-header">
            <button id="back-to-list-btn"><svg class="icon" style="transform: rotate(180deg);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"></path></svg></button>
            <div class="chat-title-group"><h2 id="chat-title"></h2><div id="typing-indicator"></div></div>
        </header>
        <main class="messages-list" id="messages-list"></main>
        <footer class="message-form-container">
            <form id="message-form" onsubmit="return false;">
                <input type="text" id="message-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." autocomplete="off">
                <button type="button" id="send-button"><svg class="icon" style="transform: rotate(-45deg); margin-left: -3px;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg></button>
            </form>
        </footer>
    </div>
    
    <div id="toast-container"></div>
</div>

<script type="module">
    // --- 1. ØªÙ‡ÙŠØ¦Ø© FIREBASE ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getDatabase, ref, get, set, update, push, onChildAdded, onChildChanged, onValue, off, onDisconnect, serverTimestamp, query, limitToLast, onChildRemoved } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyDPQInwJ5Ifm2urgQsSNzK7ZpKTaxSmutY",
      authDomain: "chat-app-b4ae1.firebaseapp.com",
      databaseURL: "https://chat-app-b4ae1-default-rtdb.firebaseio.com",
      projectId: "chat-app-b4ae1",
      storageBucket: "chat-app-b4ae1.firebasestorage.app",
      messagingSenderId: "358771246997",
      appId: "1:358771246997:web:9cfdabf18b7348fc10989c"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // [Ø¬Ø¯ÙŠØ¯] Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¶Ø¹ Ø§Ù„ØµÙŠØ§Ù†Ø©
    onValue(ref(db, 'system/settings/maintenanceMode'), (snapshot) => {
        if (snapshot.val() === true) {
            document.body.innerHTML = `<div style="text-align:center; padding:40px; color:#fff; background-color:#34495e; height:100vh; display:flex; flex-direction:column; justify-content:center; align-items:center;"><h1>Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ØªØ­Øª Ø§Ù„ØµÙŠØ§Ù†Ø©</h1><p>Ù†Ø­Ù† Ù†Ù‚ÙˆÙ… Ø¨Ø¨Ø¹Ø¶ Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§ØªØŒ Ø³Ù†Ø¹ÙˆØ¯ Ù‚Ø±ÙŠØ¨Ù‹Ø§.</p></div>`;
        }
    }, { onlyOnce: true });

    // --- 2. Ø¥Ø¯Ø§Ø±Ø© Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙˆØ¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ---
    let currentUser = null, activeChat = null, typingTimeout = null, lastAnnouncementTimestamp = 0;
    let activeListeners = {}; 

    const statusIcons = {
        sent: `<svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path></svg>`,
        read: `<svg class="icon-sm" style="stroke: var(--read-receipt-color);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4.5 12.75l6 6 9-13.5" /><path d="M19.5 7.5l-9 9-4.5-4.5" /></svg>`
    };
    
    // ... (DOM element references are the same)
    const authView = document.getElementById('auth-view'), mainAppView = document.getElementById('main-app-view'),
          chatView = document.getElementById('chat-view'), loginForm = document.getElementById('login-form'),
          signupForm = document.getElementById('signup-form'), loginError = document.getElementById('login-error'),
          signupError = document.getElementById('signup-error'), welcomeMessage = document.getElementById('welcome-message'),
          logoutBtn = document.getElementById('logout-btn'), navButtons = document.querySelectorAll('.nav-btn'),
          contentViews = document.querySelectorAll('#app-content > .list-view'),
          privateChatsList = document.getElementById('private-chats-list'),
          searchUserForm = document.getElementById('search-user-form'), searchResults = document.getElementById('search-results'),
          backToListBtn = document.getElementById('back-to-list-btn'), chatTitle = document.getElementById('chat-title'),
          typingIndicator = document.getElementById('typing-indicator'), messagesList = document.getElementById('messages-list'),
          messageForm = document.getElementById('message-form'), messageInput = document.getElementById('message-input'),
          sendButton = document.getElementById('send-button'), friendRequestsList = document.getElementById('friend-requests-list'),
          noPrivateChatsPlaceholder = document.getElementById('no-private-chats-placeholder'),
          settingUsername = document.getElementById('setting-username'), settingDisplayName = document.getElementById('setting-display-name'),
          editDisplayNameBtn = document.getElementById('edit-display-name-btn'), editDisplayNameForm = document.getElementById('edit-display-name-form'),
          newDisplayNameInput = document.getElementById('new-display-name-input'), cancelEditDisplayName = document.getElementById('cancel-edit-display-name'),
          displayNameContainer = document.getElementById('display-name-container'), togglePasswordFormBtn = document.getElementById('toggle-password-form-btn'),
          changePasswordSection = document.getElementById('change-password-section'), changePasswordForm = document.getElementById('change-password-form'),
          friendsManagementList = document.getElementById('friends-management-list'), deleteAccountBtn = document.getElementById('delete-account-btn');


    // --- 3. Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ---
    document.getElementById('show-signup').addEventListener('click', () => { signupForm.classList.remove('hidden'); loginForm.classList.add('hidden'); });
    document.getElementById('show-login').addEventListener('click', () => { loginForm.classList.remove('hidden'); signupForm.classList.add('hidden'); });
    
    signupForm.addEventListener('submit', async e => {
        e.preventDefault(); signupError.textContent = '';
        const username = document.getElementById('signup-username').value.trim().toLowerCase();
        const displayName = document.getElementById('signup-displayname').value.trim();
        const password = document.getElementById('signup-password').value;
        if (!username || !displayName || !password) { signupError.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„.'; return; }

        const userRef = ref(db, 'users/' + username);
        if ((await get(userRef)).exists()) { 
            signupError.textContent = 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ù…Ø­Ø¬ÙˆØ².'; 
        } else { 
            const userData = { displayName, password, createdAt: serverTimestamp(), isBanned: false };
            await set(userRef, userData); 
            push(ref(db, 'system/live_activity'), { type: 'NEW_USER', message: `Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯: ${displayName} (@${username})`, timestamp: serverTimestamp() });
            loginSuccess({ username, ...userData }); 
        }
    });

    loginForm.addEventListener('submit', async e => {
        e.preventDefault(); loginError.textContent = '';
        const username = document.getElementById('login-username').value.trim().toLowerCase();
        const password = document.getElementById('login-password').value;
        const userRef = ref(db, 'users/' + username);
        const snapshot = await get(userRef);

        if (snapshot.exists()) {
            const userData = snapshot.val();
            if (userData.isBanned === true) { loginError.textContent = 'Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø­Ø¸ÙˆØ±.'; return; }
            if (userData.password === password) { loginSuccess({ username, ...userData }); } 
            else { loginError.textContent = 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.'; }
        } else { loginError.textContent = 'Ø§Ù„Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ ØªÙ… Ø­Ø°ÙÙ‡.'; }
    });

    function loginSuccess(userData) {
        currentUser = userData;
        localStorage.setItem('chatUser', JSON.stringify(currentUser));
        authView.classList.add('hidden'); mainAppView.classList.remove('hidden');
        welcomeMessage.textContent = `Ø£Ù‡Ù„Ø§Ù‹ØŒ ${currentUser.displayName}`;
        initializeMainApp(); setupGlobalPresence();
        listenForSystemChanges(); // [Ø¬Ø¯ÙŠØ¯]
    }
    
    function forceLogout(reason) {
        if(currentUser) set(ref(db, `presence/${currentUser.username}`), false);
        currentUser = null; localStorage.removeItem('chatUser');
        Object.values(activeListeners).forEach(l => { if(l && l.ref) off(l.ref, l.event, l.callback) });
        activeListeners = {};
        document.body.innerHTML = `<div style="text-align:center; padding:40px; color:#fff; background-color:var(--danger-color); height:100vh; display:flex; flex-direction:column; justify-content:center; align-items:center;"><h1>ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</h1><p>${reason}</p><button onclick="location.reload()" style="padding:10px 20px; border:1px solid #fff; background:transparent; color:#fff; border-radius:8px; margin-top:20px; cursor:pointer;">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„</button></div>`;
    }

    logoutBtn.addEventListener('click', () => {
        if(currentUser) set(ref(db, `presence/${currentUser.username}`), false);
        location.reload(); // Simple reload will clear state and show login
    });

    window.addEventListener('load', () => {
        const savedUser = localStorage.getItem('chatUser');
        if (savedUser) loginSuccess(JSON.parse(savedUser));
    });

    // ... (setupGlobalPresence, initializeMainApp, navButtons, showView, openChat, backToListBtn are mostly the same)
    
    // --- [Ø¬Ø¯ÙŠØ¯] Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© (Ø§Ù„Ø­Ø¸Ø±ØŒ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª) ---
    function listenForSystemChanges() {
        // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¸Ø±
        const userStatusRef = ref(db, `users/${currentUser.username}`);
        activeListeners.userStatus = { ref: userStatusRef, event: 'value', callback: onValue(userStatusRef, (snap) => {
            if (!snap.exists()) {
                forceLogout('ØªÙ… Ø­Ø°Ù Ø­Ø³Ø§Ø¨Ùƒ Ø¨ÙˆØ§Ø³Ø·Ø© Ù…Ø´Ø±Ù.');
                return;
            }
            const userData = snap.val();
            if (userData.isBanned) {
                forceLogout('ØªÙ… Ø­Ø¸Ø± Ø­Ø³Ø§Ø¨Ùƒ Ø¨ÙˆØ§Ø³Ø·Ø© Ù…Ø´Ø±Ù.');
            }
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¥Ø°Ø§ ØºÙŠØ± Ø§Ù„Ù…Ø´Ø±Ù Ø§Ù„Ø§Ø³Ù…
            if(userData.displayName !== currentUser.displayName){
                currentUser.displayName = userData.displayName;
                localStorage.setItem('chatUser', JSON.stringify(currentUser));
                welcomeMessage.textContent = `Ø£Ù‡Ù„Ø§Ù‹ØŒ ${currentUser.displayName}`;
                if(document.getElementById('settings-view').offsetParent) settingDisplayName.textContent = currentUser.displayName;
            }
        })};
        
        // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        const announcementsRef = query(ref(db, 'system/announcements'), limitToLast(1));
        activeListeners.announcements = { ref: announcementsRef, event: 'child_added', callback: onChildAdded(announcementsRef, (snap) => {
             const announcement = snap.val();
             // Ù…Ù†Ø¹ Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¹Ù†Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
             if (announcement.timestamp > lastAnnouncementTimestamp) {
                showToast(`ğŸ“¢ Ø¥Ø¹Ù„Ø§Ù†: ${announcement.message}`, 'info', 5000);
                lastAnnouncementTimestamp = announcement.timestamp;
             }
        })};
    }


    // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ù…Ø¹Ø¸Ù… Ø§Ù„Ø¯ÙˆØ§Ù„ ÙƒÙ…Ø§ Ù‡ÙŠØŒ Ù…Ø¹ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ø³ÙŠØ·Ø©) ---

    editDisplayNameForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const newName = newDisplayNameInput.value.trim();
        if (newName && newName !== currentUser.displayName) {
            await update(ref(db, `users/${currentUser.username}`), { displayName: newName });
            // [Ø¬Ø¯ÙŠØ¯] ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†Ø´Ø§Ø·
            push(ref(db, 'system/live_activity'), { type: 'NAME_CHANGE', message: `ØºÙŠÙ‘Ø± ${currentUser.displayName} Ø§Ø³Ù…Ù‡ Ø¥Ù„Ù‰ ${newName}`, timestamp: serverTimestamp() });
            currentUser.displayName = newName;
            localStorage.setItem('chatUser', JSON.stringify(currentUser));
            welcomeMessage.textContent = `Ø£Ù‡Ù„Ø§Ù‹ØŒ ${newName}`;
            settingDisplayName.textContent = newName;
            showToast("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù… Ø¨Ù†Ø¬Ø§Ø­.", "success");
        }
        cancelEditDisplayName.click();
    });

    async function sendMessage() {
        const text = messageInput.value.trim();
        if (!text || !activeChat) return;

        const bannedWordsSnap = await get(ref(db, 'system/settings/bannedWords'));
        const bannedWords = bannedWordsSnap.exists() ? Object.keys(bannedWordsSnap.val()) : [];
        let isFlagged = bannedWords.some(word => text.toLowerCase().includes(word.toLowerCase()));

        const messageData = {
            senderId: currentUser.username, senderName: currentUser.displayName,
            text, status: 'sent', timestamp: serverTimestamp(), isFlagged
        };
        messageInput.value = ''; sendButton.classList.remove('has-text'); setTypingStatus(false);
        await push(ref(db, getChatPath()), messageData);

        if (isFlagged) {
             push(ref(db, 'system/reports'), {
                type: 'FLAGGED_MESSAGE', reportedUserId: currentUser.username,
                messageText: text, chatId: [currentUser.username, activeChat.id].sort().join('-'),
                timestamp: serverTimestamp()
            });
            // [Ø¬Ø¯ÙŠØ¯] ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†Ø´Ø§Ø·
            push(ref(db, 'system/live_activity'), { type: 'FLAGGED_MSG', message: `Ø±Ø³Ø§Ù„Ø© Ù…Ø®Ø§Ù„ÙØ© Ù…Ù† @${currentUser.username}`, timestamp: serverTimestamp() });
        }
    }

    // --- Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© (Ù…Ø¹ ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø³ÙŠØ· Ù„Ù€ showToast) ---
    function showToast(message, type = "success", duration = 3000) {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`; toast.innerHTML = message; // Use innerHTML for icons
        container.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
            toast.classList.remove('show');
            toast.addEventListener('transitionend', () => toast.remove());
        }, duration);
    }
    function escapeHTML(str) { return str ? str.toString().replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;') : '' }

    // --- Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ ---
    // The rest of the functions (like presence, chat listening, message rendering, settings population, etc.)
    // remain largely the same as in your original file. I've only pasted the modified or new functions
    // here to keep the response concise. You should integrate these changes into your existing `Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø§ÙˆÙ„ÙŠ.html`.
    // For a complete working version, you'd merge the new/modified functions with the old ones.
    
    // Placeholder for functions that are unchanged
    function setupGlobalPresence() { const presenceRef = ref(db, `presence/${currentUser.username}`); onDisconnect(presenceRef).set(false); set(presenceRef, true); }
    function initializeMainApp() { showView('private-chats-list-view'); listenForPrivateChats(); listenForFriendRequests(); setupSettingsViewListeners(); }
    navButtons.forEach(btn => btn.addEventListener('click', () => { navButtons.forEach(b => b.classList.remove('active')); btn.classList.add('active'); showView(btn.dataset.view); }));
    function showView(viewId) { contentViews.forEach(v => v.classList.add('hidden')); document.getElementById(viewId).classList.remove('hidden'); if(viewId === 'settings-view') populateSettingsView(); if (viewId === 'search-view') renderSearchPlaceholder('Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£ØµØ¯Ù‚Ø§Ø¡ Ø¬Ø¯Ø¯!', 'user-plus'); }
    function openChat(chatConfig) { detachChatListeners(); activeChat = chatConfig; chatTitle.textContent = activeChat.name; messagesList.innerHTML = `<div class="chat-start-info">Ù‡Ø°Ù‡ Ù‡ÙŠ Ø¨Ø¯Ø§ÙŠØ© Ù…Ø­Ø§Ø¯Ø«ØªÙƒ Ù…Ø¹ ${escapeHTML(activeChat.name)}</div>`; chatView.classList.add('active'); attachChatListeners(); }
    backToListBtn.addEventListener('click', () => { chatView.classList.remove('active'); if (activeChat) setTypingStatus(false); detachChatListeners(); activeChat = null; });
    searchUserForm.addEventListener('submit', async e => { e.preventDefault(); const searchUsername = document.getElementById('search-username-input').value.trim().toLowerCase(); searchResults.innerHTML = `<div class="loader"></div>`; if (!searchUsername || searchUsername === currentUser.username) { renderSearchPlaceholder('Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù†ÙØ³Ùƒ.', 'ban'); return; } const userSnapshot = await get(ref(db, 'users/' + searchUsername)); if (!userSnapshot.exists()) { renderSearchPlaceholder(`Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… "${searchUsername}"`, 'search-off'); return; } const userData = userSnapshot.val(); const partnerId = userSnapshot.key; const areFriendsSnapshot = await get(ref(db, `user_chats/${currentUser.username}/${[currentUser.username, partnerId].sort().join('-')}`)); const requestSentSnapshot = await get(ref(db, `friend_requests/${partnerId}/${currentUser.username}`)); const requestReceivedSnapshot = await get(ref(db, `friend_requests/${currentUser.username}/${partnerId}`)); let actionHtml = ''; if (areFriendsSnapshot.exists()) actionHtml = `<span>ØµØ¯ÙŠÙ‚ Ø¨Ø§Ù„ÙØ¹Ù„</span>`; else if (requestSentSnapshot.exists()) actionHtml = `<span>ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</span>`; else if (requestReceivedSnapshot.exists()) actionHtml = `<span>Ù„Ø¯ÙŠÙƒ Ø·Ù„Ø¨ ØµØ¯Ø§Ù‚Ø© Ù…Ù†Ù‡</span>`; else actionHtml = `<button class="send-request-btn" data-id="${partnerId}" data-name="${userData.displayName}">Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨</button>`; searchResults.innerHTML = `<div class="search-result-item"><div class="result-content"><div class="avatar">${escapeHTML(userData.displayName.charAt(0).toUpperCase())}</div><div class="user-info"><span class="display-name">${escapeHTML(userData.displayName)}</span><span class="username">@${partnerId}</span></div><div class="result-action">${actionHtml}</div></div></div>`; const sendBtn = searchResults.querySelector('button.send-request-btn'); if (sendBtn) sendBtn.addEventListener('click', sendFriendRequest); });
    function renderSearchPlaceholder(message, icon) { const icons = { 'user-plus': `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path></svg>`, 'ban': `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path></svg>`, 'search-off': `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 10l-4 4m4-4l4 4"></path></svg>`, }; searchResults.innerHTML = `<div class="search-placeholder">${icons[icon] || icons['user-plus']}<p>${escapeHTML(message)}</p></div>`; }
    function sendFriendRequest(e) { const targetId = e.target.dataset.id, targetName = e.target.dataset.name; set(ref(db, `friend_requests/${targetId}/${currentUser.username}`), { senderName: currentUser.displayName, timestamp: serverTimestamp() }).then(() => { showToast(`ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØµØ¯Ø§Ù‚Ø© Ø¥Ù„Ù‰ ${targetName}`, "success"); e.target.parentElement.innerHTML = '<span>ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</span>'; }); }
    function listenForFriendRequests() { const requestsRef = ref(db, `friend_requests/${currentUser.username}`); onChildAdded(requestsRef, s => displayFriendRequest(s.key, s.val())); onChildRemoved(requestsRef, s => document.getElementById(`request-${s.key}`)?.remove()); }
    function displayFriendRequest(senderId, requestData) { const li = document.createElement('li'); li.className = 'request-item'; li.id = `request-${senderId}`; li.innerHTML = `<span class="list-item-content">${escapeHTML(requestData.senderName)}</span><div class="request-actions"><button class="accept-btn" data-id="${senderId}" data-name="${requestData.senderName}">Ù‚Ø¨ÙˆÙ„</button><button class="decline-btn" data-id="${senderId}">Ø±ÙØ¶</button></div>`; friendRequestsList.prepend(li); li.querySelector('.accept-btn').addEventListener('click', acceptFriendRequest); li.querySelector('.decline-btn').addEventListener('click', declineFriendRequest); }
    async function acceptFriendRequest(e) { const partnerId = e.target.dataset.id, partnerName = e.target.dataset.name; const chatId = [currentUser.username, partnerId].sort().join('-'); const updates = {}; updates[`user_chats/${currentUser.username}/${chatId}`] = { partnerId, partnerName }; updates[`user_chats/${partnerId}/${chatId}`] = { partnerId: currentUser.username, partnerName: currentUser.displayName }; updates[`friend_requests/${currentUser.username}/${partnerId}`] = null; await update(ref(db), updates); showToast(`Ù„Ù‚Ø¯ Ø£ØµØ¨Ø­Øª ØµØ¯ÙŠÙ‚Ù‹Ø§ Ù„Ù€ ${partnerName}`, "success"); }
    function declineFriendRequest(e) { const senderId = e.target.dataset.id; set(ref(db, `friend_requests/${currentUser.username}/${senderId}`), null); showToast("ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨.", "success"); }
    function listenForPrivateChats() { const chatsRef = ref(db, `user_chats/${currentUser.username}`); if(activeListeners.chatAdded) off(activeListeners.chatAdded.ref, 'child_added', activeListeners.chatAdded.callback); if(activeListeners.chatRemoved) off(activeListeners.chatRemoved.ref, 'child_removed', activeListeners.chatRemoved.callback); const checkEmptyList = () => { noPrivateChatsPlaceholder.style.display = privateChatsList.children.length > 1 ? 'none' : 'list-item'; }; checkEmptyList(); activeListeners.chatAdded = { ref: chatsRef, event: 'child_added', callback: onChildAdded(chatsRef, (s) => { const chatData = s.val(); if (!chatData) return; noPrivateChatsPlaceholder.style.display = 'none'; const li = document.createElement('li'); li.className = 'list-item'; li.id = `private-chat-${chatData.partnerId}`; li.innerHTML = `<div class="list-item-content">${escapeHTML(chatData.partnerName)}</div><div id="presence-${chatData.partnerId}" class="online-indicator"></div>`; li.addEventListener('click', () => openChat({type: 'private', id: chatData.partnerId, name: `${chatData.partnerName}`})); privateChatsList.appendChild(li); const presenceRef = ref(db, `presence/${chatData.partnerId}`); onValue(presenceRef, pSnap => { const indicator = document.getElementById(`presence-${chatData.partnerId}`); if(indicator) indicator.classList.toggle('online', pSnap.val() === true); }); })}; activeListeners.chatRemoved = { ref: chatsRef, event: 'child_removed', callback: onChildRemoved(chatsRef, (s) => { const partnerId = s.val()?.partnerId; if (partnerId) document.getElementById(`private-chat-${partnerId}`)?.remove(); checkEmptyList(); if (document.getElementById('settings-view').offsetParent !== null) populateFriendsForUnfriending(); })}; }
    function getChatPath() { if (!activeChat) return null; return `private_chats/${[currentUser.username, activeChat.id].sort().join('-')}/messages`; }
    function attachChatListeners() { const path = getChatPath(); if (!path) return; const messagesRef = ref(db, path); const q = query(messagesRef, limitToLast(50)); activeListeners.msgAdd = { ref: q, event: 'child_added', callback: onChildAdded(q, s => displayMessage(s.val(), s.key)) }; activeListeners.msgChange = { ref: messagesRef, event: 'child_changed', callback: onChildChanged(messagesRef, s => updateMessageDisplay(s.key, s.val())) }; updateUnreadMessages(); const typingRef = ref(db, `typing_indicators/${[currentUser.username, activeChat.id].sort().join('-')}/${activeChat.id}`); activeListeners.typing = { ref: typingRef, event: 'value', callback: onValue(typingRef, s => typingIndicator.textContent = s.val() === true ? "ÙŠÙƒØªØ¨ Ø§Ù„Ø¢Ù†..." : "") }; }
    function detachChatListeners() { Object.keys(activeListeners).forEach(key => { if (key.startsWith('msg') || key.startsWith('typing')) { const l = activeListeners[key]; if (l && l.ref) off(l.ref, l.event, l.callback); delete activeListeners[key]; } }); }
    sendButton.addEventListener('click', sendMessage); messageInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
    function deleteMessage(messageId) { if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹ØŸ")) return; update(ref(db, `${getChatPath()}/${messageId}`), { text: "ØªÙ… Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©", isDeleted: true }); }
    function displayMessage(data, id) { if (!data) return; const lastMessageEl = messagesList.querySelector('.message:last-of-type'); const isConsecutive = lastMessageEl && lastMessageEl.dataset.senderId === data.senderId && !lastMessageEl.classList.contains('deleted'); if(isConsecutive){ lastMessageEl.classList.add('consecutive'); } const el = document.createElement('div'); el.className = 'message'; el.dataset.messageId = id; el.dataset.senderId = data.senderId; const isMyMsg = data.senderId === currentUser.username; el.classList.add(isMyMsg ? 'my-message' : 'other-message'); if (data.isDeleted) el.classList.add('deleted'); if (data.isFlagged) el.classList.add('flagged'); const time = data.timestamp ? new Date(data.timestamp).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }) : ''; el.innerHTML = `<div class="message-text">${escapeHTML(data.text)}</div><div class="message-meta"><span>${time}</span>${isMyMsg ? `<span class="message-status">${data.status === 'read' ? statusIcons.read : statusIcons.sent}</span>` : ''}</div>${isMyMsg && !data.isDeleted ? `<button class="delete-btn" data-id="${id}">Ã—</button>` : ''}`; messagesList.appendChild(el); const deleteBtn = el.querySelector('.delete-btn'); if (deleteBtn) deleteBtn.addEventListener('click', (e) => deleteMessage(e.target.dataset.id)); messagesList.scrollTop = messagesList.scrollHeight; }
    function updateMessageDisplay(id, data) { const messageEl = document.querySelector(`[data-message-id="${id}"]`); if (!messageEl) return; if (data.senderId === currentUser.username) { const statusEl = messageEl.querySelector('.message-status'); if (statusEl && data.status === 'read') statusEl.innerHTML = statusIcons.read; } if (data.isDeleted) { messageEl.classList.add('deleted'); messageEl.querySelector('.message-text').innerHTML = `<i>${escapeHTML(data.text)}</i>`; messageEl.querySelector('.delete-btn')?.remove(); } }
    function updateUnreadMessages() { const path = getChatPath(); if (!path) return; get(query(ref(db, path), limitToLast(50))).then(s => { if (!s.exists()) return; s.forEach(c => { if (c.val().senderId !== currentUser.username && c.val().status !== 'read') { update(ref(db, `${path}/${c.key}`), { status: 'read' }); } }); }); }
    messageInput.addEventListener('input', () => { sendButton.classList.toggle('has-text', messageInput.value.trim() !== ''); if (!activeChat) return; clearTimeout(typingTimeout); setTypingStatus(true); typingTimeout = setTimeout(() => setTypingStatus(false), 2000); });
    function setTypingStatus(isTyping) { if (!activeChat) return; const typingRef = ref(db, `typing_indicators/${[currentUser.username, activeChat.id].sort().join('-')}/${currentUser.username}`); if (isTyping) set(typingRef, true); else onDisconnect(typingRef).remove().then(() => ref(db, `typing_indicators/${[currentUser.username, activeChat.id].sort().join('-')}/${currentUser.username}`).remove()); }
    function populateSettingsView() { if (!currentUser) return; settingUsername.textContent = currentUser.username; settingDisplayName.textContent = currentUser.displayName; populateFriendsForUnfriending(); }
    function setupSettingsViewListeners() { editDisplayNameBtn.addEventListener('click', () => { displayNameContainer.querySelector('.settings-item').classList.add('hidden'); editDisplayNameForm.classList.remove('hidden'); newDisplayNameInput.value = currentUser.displayName; newDisplayNameInput.focus(); }); cancelEditDisplayName.addEventListener('click', () => { displayNameContainer.querySelector('.settings-item').classList.remove('hidden'); editDisplayNameForm.classList.add('hidden'); }); editDisplayNameForm.addEventListener('submit', async(e) => { /* Implemented above */ }); togglePasswordFormBtn.addEventListener('click', () => { changePasswordSection.classList.toggle('hidden'); }); changePasswordForm.addEventListener('submit', async e => { e.preventDefault(); const oldPass = document.getElementById('old-password').value, newPass = document.getElementById('new-password').value; if (!oldPass || !newPass) { showToast("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„.", "error"); return; } const s = await get(ref(db, 'users/' + currentUser.username)); if (s.exists() && s.val().password === oldPass) { await update(ref(db, 'users/' + currentUser.username), { password: newPass }); showToast("ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­", "success"); e.target.reset(); changePasswordSection.classList.add('hidden'); } else { showToast("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø©", "error"); } }); deleteAccountBtn.addEventListener('click', () => { const conf = prompt("Ù„Ù„ØªØ£ÙƒÙŠØ¯ØŒ Ø§ÙƒØªØ¨ 'Ø­Ø°Ù':"); if (conf === 'Ø­Ø°Ù') deleteUserAccount(); else showToast("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­Ø°Ù.", "error"); }); }
    async function populateFriendsForUnfriending() { friendsManagementList.innerHTML = '<li><em>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</em></li>'; const s = await get(ref(db, `user_chats/${currentUser.username}`)); if (s.exists() && s.size > 0) { friendsManagementList.innerHTML = ''; s.forEach(c => { const friend = c.val(); if(friend.partnerId) { const li = document.createElement('li'); li.className = 'friend-item'; li.innerHTML = `<span>${escapeHTML(friend.partnerName)}</span><button class="remove-btn" data-id="${friend.partnerId}">Ø¥Ø²Ø§Ù„Ø©</button>`; li.querySelector('.remove-btn').addEventListener('click', unfriendUser); friendsManagementList.appendChild(li); } }); } else { friendsManagementList.innerHTML = '<li style="padding: 15px; text-align:center;"><em>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ØµØ¯Ù‚Ø§Ø¡ Ø­Ø§Ù„ÙŠÙ‹Ø§.</em></li>'; } }
    async function unfriendUser(e) { const friendId = e.target.dataset.id; if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø²Ø§Ù„Ø© Ù‡Ø°Ø§ Ø§Ù„ØµØ¯ÙŠÙ‚ØŸ`)) return; const chatId = [currentUser.username, friendId].sort().join('-'); const updates = {}; updates[`user_chats/${currentUser.username}/${chatId}`] = null; updates[`user_chats/${friendId}/${chatId}`] = null; await update(ref(db), updates); showToast("ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµØ¯ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­.", "success"); }
    async function deleteUserAccount() { if (!currentUser) return; showToast("Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø­Ø³Ø§Ø¨Ùƒ...", "success"); try { const userId = currentUser.username; const updates = {}; const userChatsSnapshot = await get(ref(db, `user_chats/${userId}`)); if (userChatsSnapshot.exists()) { userChatsSnapshot.forEach(chatSnapshot => { const chatId = chatSnapshot.key; if(chatSnapshot.val()){ const partnerId = chatSnapshot.val().partnerId; updates[`user_chats/${partnerId}/${chatId}`] = null; updates[`private_chats/${chatId}`] = null; } }); } updates[`users/${userId}`] = null; updates[`presence/${userId}`] = null; updates[`user_chats/${userId}`] = null; updates[`friend_requests/${userId}`] = null; const allRequestsSnapshot = await get(ref(db, 'friend_requests')); if (allRequestsSnapshot.exists()) { allRequestsSnapshot.forEach(recipientSnapshot => { if (recipientSnapshot.hasChild(userId)) { updates[`friend_requests/${recipientSnapshot.key}/${userId}`] = null; } }); } await update(ref(db), updates); showToast("ØªÙ… Ø­Ø°Ù Ø­Ø³Ø§Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­.", "success"); setTimeout(() => forceLogout("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­."), 1500); } catch (error) { showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨.", "error"); } }

</script>
</body>
</html>